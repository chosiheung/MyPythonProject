import pandas as pd
import numpy as np
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense
from sklearn.preprocessing import MinMaxScaler
from sklearn.model_selection import train_test_split
import matplotlib.pyplot as plt

# ----------------------------------------------------------------------
# 1. ë°ì´í„° ë¡œë“œ ë° í™•ì¸ (íŒŒì¼ ê²½ë¡œ ìˆ˜ì • ì™„ë£Œ)
# ----------------------------------------------------------------------
print("--- 1. ë°ì´í„° ë¡œë“œ ë° í™•ì¸ ---")

# ğŸš¨ğŸš¨ğŸš¨ ì‚¬ìš©ìë‹˜ì˜ ìš”ì²­ì— ë”°ë¼ S: ë“œë¼ì´ë¸Œ ê²½ë¡œë¥¼ ë°˜ì˜í–ˆìŠµë‹ˆë‹¤.
FILE_PATH = 'S:/ë°”íƒ•í™”ë©´/sample2/output_min_feedback_per_cycle_íŒŒì†ì—¬ë¶€ ì¶”ê°€.xlsx' 

try:
    # ì—‘ì…€ íŒŒì¼ ë¡œë“œ
    df = pd.read_excel(FILE_PATH) 
    
except FileNotFoundError:
    print(f"ì˜¤ë¥˜: íŒŒì¼ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”: {FILE_PATH}")
    exit() 
except Exception as e:
    print(f"íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
    exit()

# ë°ì´í„°í”„ë ˆì„ì˜ ì²« 5í–‰ í™•ì¸
print("ë¡œë“œëœ ë°ì´í„°:")
print(df.head())

# LSTM ì…ë ¥ íŠ¹ì„± ì„ íƒ: ê²½ê³¼ì‹œê°„, ì»¤ë§¨ë“œê°’, í”¼ë“œë°±ê°’
features = df[['ê²½ê³¼ì‹œê°„', 'ì»¤ë§¨ë“œê°’', 'í”¼ë“œë°±ê°’']].values


# ----------------------------------------------------------------------
# 2. ë°ì´í„° ì „ì²˜ë¦¬
# ----------------------------------------------------------------------

# 2-1. ì •ê·œí™” (MinMaxScaler)
scaler = MinMaxScaler()
scaled_features = scaler.fit_transform(features)

# 2-2. ì‹œí€€ìŠ¤ ë°ì´í„° ìƒì„± í•¨ìˆ˜
def create_sequences(data, time_step):
    """
    LSTM í•™ìŠµì„ ìœ„í•œ ì‹œí€€ìŠ¤ (X)ì™€ ì˜ˆì¸¡ íƒ€ê²Ÿ (y)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    yëŠ” ë‹¤ìŒ ì‹œì ì˜ 'í”¼ë“œë°±ê°’'(ì¸ë±ìŠ¤ 2)ì…ë‹ˆë‹¤.
    """
    X, y = [], []
    for i in range(len(data) - time_step):
        X.append(data[i:(i + time_step), :])
        y.append(data[i + time_step, 2])
    return np.array(X), np.array(y)

# í•˜ì´í¼íŒŒë¼ë¯¸í„°: Time Step ì„¤ì •
TIME_STEP = 10 
X, y = create_sequences(scaled_features, TIME_STEP)

print(f"\nì…ë ¥ ì‹œí€€ìŠ¤ X.shape: {X.shape}") 
print(f"íƒ€ê²Ÿ Y.shape: {y.shape}")

if X.shape[0] == 0:
    print("ì˜¤ë¥˜: ë°ì´í„°ì˜ ê¸¸ì´ê°€ Time Stepë³´ë‹¤ ì§§ì•„ ì‹œí€€ìŠ¤ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit()

# 2-3. í›ˆë ¨/í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¶„í• 
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, shuffle=False)
print(f"í›ˆë ¨ ë°ì´í„° X_train.shape: {X_train.shape}, y_train.shape: {y_train.shape}")


# ----------------------------------------------------------------------
# 3. LSTM ëª¨ë¸ êµ¬ì¶• ë° í›ˆë ¨
# ----------------------------------------------------------------------
print("\n--- 3. LSTM ëª¨ë¸ êµ¬ì¶• ë° í•™ìŠµ ---")

# í•˜ì´í¼íŒŒë¼ë¯¸í„° ì„¤ì •
EPOCHS = 50

BATCH_SIZE = 1 

# ëª¨ë¸ êµ¬ì¶•
model = Sequential()
model.add(LSTM(
    units=50, 
    activation='relu', 
    input_shape=(X_train.shape[1], X_train.shape[2])
))
model.add(Dense(units=1)) 

# ëª¨ë¸ ì»´íŒŒì¼ (íšŒê·€: MSE)
model.compile(optimizer='adam', loss='mse')

# ëª¨ë¸ í•™ìŠµ
history = model.fit(
    X_train, 
    y_train, 
    epochs=EPOCHS, 
    batch_size=BATCH_SIZE, 
    validation_split=0.1, 
    verbose=2 
)
print("--- ëª¨ë¸ í•™ìŠµ ì™„ë£Œ ---")

# ----------------------------------------------------------------------
# 4. ì˜ˆì¸¡ ë° ê²°ê³¼ ì‹œê°í™”
# ----------------------------------------------------------------------
print("\n--- 4. ì˜ˆì¸¡ ë° ê²°ê³¼ ---")

# í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ì˜ˆì¸¡ ìˆ˜í–‰
y_pred_scaled = model.predict(X_test)

# ì—­ì •ê·œí™”ë¥¼ ìœ„í•œ í•¨ìˆ˜ ì •ì˜
def inverse_transform_data(scaled_y, scaler, feature_index=2, total_features=3):
    """ì •ê·œí™”ëœ ì˜ˆì¸¡ê°’ë§Œ ì—­ì •ê·œí™”í•©ë‹ˆë‹¤."""
    dummy_data = np.zeros((len(scaled_y), total_features))
    dummy_data[:, feature_index] = scaled_y.flatten()
    return scaler.inverse_transform(dummy_data)[:, feature_index]

# ì‹¤ì œ ì˜ˆì¸¡ê°’ê³¼ í…ŒìŠ¤íŠ¸ ê°’ ì—­ì •ê·œí™”
y_pred_original = inverse_transform_data(y_pred_scaled, scaler)
y_test_original = inverse_transform_data(y_test, scaler)

# ê²°ê³¼ ì¶œë ¥
print("LSTM í”¼ë“œë°± ê°’ ì˜ˆì¸¡ ê²°ê³¼ (ì›ë˜ ìŠ¤ì¼€ì¼):")
results = pd.DataFrame({
    'Actual_Feedback': y_test_original,
    'Predicted_Feedback': y_pred_original
})
print(results)

# ì‹œê°í™”
plt.figure(figsize=(14, 7))
plt.plot(y_test_original, label='Actual Feedback Value', marker='o')
plt.plot(y_pred_original, label='Predicted Feedback Value (LSTM)', marker='x')
plt.title(f'LSTM Time Series Prediction (Time Step: {TIME_STEP}, Epochs: {EPOCHS})')
plt.xlabel('Time Step Index')
plt.ylabel('Feedback Value')
plt.legend()
plt.grid(True)
plt.show()
